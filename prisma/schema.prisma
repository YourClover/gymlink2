generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum MuscleGroup {
  CHEST
  BACK
  LEGS
  SHOULDERS
  ARMS
  CORE
  CARDIO
  FULL_BODY
}

enum Equipment {
  BARBELL
  DUMBBELL
  MACHINE
  BODYWEIGHT
  CABLE
  KETTLEBELL
  BANDS
  NONE
}

enum ExerciseType {
  STRENGTH
  CARDIO
  FLEXIBILITY
  PLYOMETRIC
}

enum WeightUnit {
  KG
  LBS
}

enum RecordType {
  MAX_WEIGHT
  MAX_REPS
  MAX_VOLUME
  MAX_TIME
}

enum AchievementCategory {
  MILESTONE
  STREAK
  PERSONAL_RECORD
  VOLUME
  CONSISTENCY
  MUSCLE_FOCUS
  EXERCISE_SPECIFIC
}

enum AchievementRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

// ============================================
// SOCIAL ENUMS
// ============================================

enum FollowStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum ChallengeType {
  TOTAL_WORKOUTS
  TOTAL_VOLUME
  WORKOUT_STREAK
  SPECIFIC_EXERCISE
  TOTAL_SETS
}

enum ChallengeStatus {
  UPCOMING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum ActivityType {
  WORKOUT_COMPLETED
  PR_ACHIEVED
  ACHIEVEMENT_EARNED
  CHALLENGE_JOINED
  CHALLENGE_COMPLETED
}

enum NotificationType {
  FOLLOW_REQUEST
  FOLLOW_ACCEPTED
  CHALLENGE_INVITE
  CHALLENGE_STARTED
  CHALLENGE_ENDED
  ACHIEVEMENT_EARNED
}

// ============================================
// MODELS
// ============================================

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String
  isAdmin      Boolean   @default(false) @map("is_admin")
  preferences  Json      @default("{}")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at") // Soft delete field

  // Relations
  workoutPlans     WorkoutPlan[]
  exercises        Exercise[]
  workoutSessions  WorkoutSession[]
  personalRecords  PersonalRecord[]
  planShareCodes   PlanShareCode[]
  userAchievements UserAchievement[]

  // Social relations
  profile                 UserProfile?
  followers               Follow[]               @relation("FollowingRelation")
  following               Follow[]               @relation("FollowerRelation")
  activityFeedItems       ActivityFeedItem[]
  createdChallenges       Challenge[]
  challengeParticipations ChallengeParticipant[]
  notifications           Notification[]

  @@index([deletedAt]) // For efficient filtering of active users
  @@map("users")
}

model WorkoutPlan {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  description String?
  isActive    Boolean  @default(false) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  planDays        PlanDay[]
  workoutSessions WorkoutSession[]
  shareCodes      PlanShareCode[]

  @@index([userId])
  @@map("workout_plans")
}

model PlanDay {
  id            String  @id @default(uuid())
  workoutPlanId String  @map("workout_plan_id")
  name          String
  dayOrder      Int     @map("day_order")
  restDay       Boolean @default(false) @map("rest_day")

  // Relations
  workoutPlan     WorkoutPlan      @relation(fields: [workoutPlanId], references: [id], onDelete: Cascade)
  planExercises   PlanExercise[]
  workoutSessions WorkoutSession[]

  @@index([workoutPlanId])
  @@map("plan_days")
}

model PlanExercise {
  id                String  @id @default(uuid())
  planDayId         String  @map("plan_day_id")
  exerciseId        String  @map("exercise_id")
  exerciseOrder     Int     @map("exercise_order")
  targetSets        Int     @map("target_sets")
  targetReps        Int?    @map("target_reps")
  targetTimeSeconds Int?    @map("target_time_seconds")
  targetWeight      Float?  @map("target_weight")
  restSeconds       Int     @default(60) @map("rest_seconds")
  notes             String?

  // Relations
  planDay  PlanDay  @relation(fields: [planDayId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@map("plan_exercises")
}

model Exercise {
  id           String       @id @default(uuid())
  name         String
  description  String?
  muscleGroup  MuscleGroup  @map("muscle_group")
  equipment    Equipment
  exerciseType ExerciseType @map("exercise_type")
  isTimed      Boolean      @default(false) @map("is_timed")
  isCustom     Boolean      @default(false) @map("is_custom")
  userId       String?      @map("user_id")
  instructions String?
  videoUrl     String?      @map("video_url")

  // Relations
  user            User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  planExercises   PlanExercise[]
  workoutSets     WorkoutSet[]
  personalRecords PersonalRecord[]
  challenges      Challenge[]
  achievements    Achievement[]

  @@index([userId])
  @@map("exercises")
}

model WorkoutSession {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  workoutPlanId   String?   @map("workout_plan_id")
  planDayId       String?   @map("plan_day_id")
  startedAt       DateTime  @default(now()) @map("started_at")
  completedAt     DateTime? @map("completed_at")
  durationSeconds Int?      @map("duration_seconds")
  notes           String?
  moodRating      Int?      @map("mood_rating")

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutPlan WorkoutPlan? @relation(fields: [workoutPlanId], references: [id], onDelete: SetNull)
  planDay     PlanDay?     @relation(fields: [planDayId], references: [id], onDelete: SetNull)
  workoutSets WorkoutSet[]

  @@index([userId])
  @@index([workoutPlanId])
  @@index([userId, completedAt]) // Composite index for efficient workout history queries
  @@map("workout_sessions")
}

model WorkoutSet {
  id               String     @id @default(uuid())
  workoutSessionId String     @map("workout_session_id")
  exerciseId       String     @map("exercise_id")
  setNumber        Int        @map("set_number")
  reps             Int?
  timeSeconds      Int?       @map("time_seconds")
  weight           Float?
  weightUnit       WeightUnit @default(KG) @map("weight_unit")
  isWarmup         Boolean    @default(false) @map("is_warmup")
  isDropset        Boolean    @default(false) @map("is_dropset")
  rpe              Int?
  completedAt      DateTime   @default(now()) @map("completed_at")
  notes            String?

  // Relations
  workoutSession  WorkoutSession   @relation(fields: [workoutSessionId], references: [id], onDelete: Cascade)
  exercise        Exercise         @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  personalRecords PersonalRecord[]

  @@index([workoutSessionId])
  @@index([exerciseId])
  @@map("workout_sets")
}

model PersonalRecord {
  id             String     @id @default(uuid())
  userId         String     @map("user_id")
  exerciseId     String     @map("exercise_id")
  recordType     RecordType @map("record_type")
  value          Float
  workoutSetId   String     @map("workout_set_id")
  achievedAt     DateTime   @default(now()) @map("achieved_at")
  previousRecord Float?     @map("previous_record")

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise   Exercise   @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  workoutSet WorkoutSet @relation(fields: [workoutSetId], references: [id], onDelete: Cascade)

  @@unique([userId, exerciseId, recordType]) // Prevent duplicate PRs for same exercise/type
  @@index([userId])
  @@index([exerciseId])
  @@map("personal_records")
}

model PlanShareCode {
  id            String   @id @default(uuid())
  code          String   @unique
  workoutPlanId String   @map("workout_plan_id")
  creatorId     String   @map("creator_id")
  expiresAt     DateTime @map("expires_at")
  usageCount    Int      @default(0) @map("usage_count")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  workoutPlan WorkoutPlan @relation(fields: [workoutPlanId], references: [id], onDelete: Cascade)
  creator     User        @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([workoutPlanId])
  @@map("plan_share_codes")
}

model Achievement {
  id          String              @id @default(uuid())
  code        String              @unique
  name        String
  description String
  category    AchievementCategory
  rarity      AchievementRarity
  icon        String
  threshold   Int                 @default(1)
  sortOrder   Int                 @default(0) @map("sort_order")
  isHidden    Boolean             @default(false) @map("is_hidden")
  exerciseId  String?             @map("exercise_id")
  createdAt   DateTime            @default(now()) @map("created_at")

  // Relations
  userAchievements UserAchievement[]
  exercise         Exercise?         @relation(fields: [exerciseId], references: [id], onDelete: SetNull)

  @@index([category])
  @@index([code])
  @@index([exerciseId])
  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  achievementId String   @map("achievement_id")
  earnedAt      DateTime @default(now()) @map("earned_at")
  notified      Boolean  @default(false)

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
  @@index([userId, earnedAt]) // For efficient achievement history queries
  @@map("user_achievements")
}

// ============================================
// SOCIAL MODELS
// ============================================

model UserProfile {
  id               String   @id @default(uuid())
  userId           String   @unique @map("user_id")
  username         String   @unique
  bio              String?
  avatarUrl        String?  @map("avatar_url")
  isPrivate        Boolean  @default(true) @map("is_private")
  showAchievements Boolean  @default(true) @map("show_achievements")
  showStats        Boolean  @default(true) @map("show_stats")
  profileCode      String   @unique @map("profile_code")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([username])
  @@index([profileCode])
  @@map("user_profiles")
}

model Follow {
  id          String       @id @default(uuid())
  followerId  String       @map("follower_id")
  followingId String       @map("following_id")
  status      FollowStatus @default(PENDING)
  createdAt   DateTime     @default(now()) @map("created_at")
  respondedAt DateTime?    @map("responded_at")

  follower  User @relation("FollowerRelation", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("FollowingRelation", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@index([status])
  @@map("follows")
}

model ActivityFeedItem {
  id           String       @id @default(uuid())
  userId       String       @map("user_id")
  activityType ActivityType @map("activity_type")
  referenceId  String?      @map("reference_id")
  metadata     Json         @default("{}")
  createdAt    DateTime     @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("activity_feed_items")
}

model Challenge {
  id              String          @id @default(uuid())
  creatorId       String          @map("creator_id")
  name            String
  description     String?
  challengeType   ChallengeType   @map("challenge_type")
  targetValue     Float           @map("target_value")
  exerciseId      String?         @map("exercise_id")
  status          ChallengeStatus @default(UPCOMING)
  startDate       DateTime        @map("start_date")
  endDate         DateTime        @map("end_date")
  isPublic        Boolean         @default(false) @map("is_public")
  inviteCode      String?         @unique @map("invite_code")
  maxParticipants Int?            @map("max_participants")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  creator      User                   @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  exercise     Exercise?              @relation(fields: [exerciseId], references: [id], onDelete: SetNull)
  participants ChallengeParticipant[]

  @@index([creatorId])
  @@index([status])
  @@index([inviteCode])
  @@map("challenges")
}

model ChallengeParticipant {
  id          String    @id @default(uuid())
  challengeId String    @map("challenge_id")
  userId      String    @map("user_id")
  progress    Float     @default(0)
  completedAt DateTime? @map("completed_at")
  joinedAt    DateTime  @default(now()) @map("joined_at")

  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([challengeId, userId])
  @@index([challengeId])
  @@index([userId])
  @@map("challenge_participants")
}

model Notification {
  id          String           @id @default(uuid())
  userId      String           @map("user_id")
  type        NotificationType
  title       String
  message     String
  referenceId String?          @map("reference_id")
  isRead      Boolean          @default(false) @map("is_read")
  createdAt   DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}
